<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>KVO原理 &amp; 自定义KVO | Philip的个人博客</title>
  
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.10.22/css/style.css">
  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Philip的博客</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Philip的个人博客
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-rss fa-fw'></i>&nbsp;博文
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="blogcategories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="blogtags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="blogarchives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)' target="_blank" rel="noopener"></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)' target="_blank" rel="noopener"></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)' target="_blank" rel="noopener"></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)' target="_blank" rel="noopener"></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="https://xaoxuu.com/wiki/material-x/"
                
                  rel="nofollow"
                
                
                id="https:xaoxuu.comwikimaterial-x">
								<i class='fas fa-book fa-fw'></i>&nbsp;主题文档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
    


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2018/01/25/2018-01-25-kvo-customized/">
        KVO原理 & 自定义KVO
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://yoursite.com" rel="nofollow">
        
          <i class="fas fa-user" aria-hidden="true"></i>
        
        <p>Philip.Lee</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2018-01-25</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/iOS/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>iOS</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html" target="_blank" rel="noopener">Apple文档</a>对 KVO 实现的描述：</p>
<blockquote>
<p>Automatic key-value observing is implemented using a technique called <em>isa-swizzling</em>.</p>
<p>The <code>isa</code> pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.</p>
<p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.</p>
<p>You should never rely on the <code>isa</code> pointer to determine class membership. Instead, you should use the <code>class</code> method to determine the class of an object instance.</p>
</blockquote>
<p>KVO（key-value observe） 是在KVC的基础上实现的一种用于监听<strong>属性</strong>变化的设计模式； 如果对某个类的某个属性设置了KVO，那么当这个属性发生变化时，就会触发监听方法，从而知道属性变化了。如果本类一个属性的改变会影响到其他多个属性的变化，我们也会经常自己重写这个属性的set方法，用来监听他的变化，但是如果不是本类的属性，我们就没办法重写其set方法了，这个时候KVO就可以上场了，其实KVO本质上也是重写set方法，而整个过程依赖于runtime才能实现。 那么对于Apple文档所说到的“intermediate class”，是如何实现的呢？</p>
<a id="more"></a>

<h1 id="首先看下是如何使用的"><a href="#首先看下是如何使用的" class="headerlink" title="首先看下是如何使用的"></a>首先看下是如何使用的</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// object添加对属性‘keyPath’进行监听</span><br><span class="line">[object addObserver:observer forKeyPath:keyPath options:context:];</span><br><span class="line">// 在对象observer中实现如下方法进行回调</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context;</span><br></pre></td></tr></table></figure>
<p>注意：在<strong>dealloc</strong>中需要对该监听进行移除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-dealloc &#123;</span><br><span class="line">	[object removeObserverForKeyPath:keyPath];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h1><ul>
<li>对属性添加监听的时候</li>
<li>内部动态生成一个该类A的子类B（就是Apple开发文档所说的intermediate class）</li>
<li>把子类B的isa指针指向该类</li>
<li>给子类B添加属性的Set方法</li>
<li>实现子类B的Set方法，同时需要调用该类A的设置方法</li>
</ul>
<h1 id="实现代码如下"><a href="#实现代码如下" class="headerlink" title="实现代码如下"></a>实现代码如下</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">// 通过还原isa指针，使用objc_msgSend调用父类的Set方法</span><br><span class="line">void setMethod1(id self, SEL _cmd, id newValue) &#123;</span><br><span class="line">    //获取get、set方法名</span><br><span class="line">    NSString *setNameStr = objc_getAssociatedObject(self, &quot;MKVO_Setter&quot;);</span><br><span class="line">    NSString *getNameStr = objc_getAssociatedObject(self, &quot;MKVO_Getter&quot;);</span><br><span class="line">    id observer = objc_getAssociatedObject(self, &quot;MKVO_Observer&quot;);</span><br><span class="line">    </span><br><span class="line">    //保存子类类型</span><br><span class="line">    Class class = [self class];</span><br><span class="line">    </span><br><span class="line">    //isa指向原类</span><br><span class="line">    object_setClass(self, class_getSuperclass(class));</span><br><span class="line">    </span><br><span class="line">    //调用原类get方法，获取oldValue</span><br><span class="line">    id oldValue = objc_msgSend(self, NSSelectorFromString(getNameStr));</span><br><span class="line">    </span><br><span class="line">    //调用原类set方法</span><br><span class="line">    objc_msgSend(self, NSSelectorFromString(setNameStr), newValue);</span><br><span class="line">    </span><br><span class="line">    NSMutableDictionary *change = @&#123;&#125;.mutableCopy;</span><br><span class="line">    if (newValue) &#123;</span><br><span class="line">        change[NSKeyValueChangeNewKey] = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">    if (oldValue) &#123;</span><br><span class="line">        change[NSKeyValueChangeOldKey] = oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    objc_msgSend(observer, @selector(observeValueForKeyPath: ofObject: change: context:), getNameStr, self, change, nil);</span><br><span class="line">    </span><br><span class="line">    //isa改回子类类型</span><br><span class="line">    object_setClass(self, class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 构造父类的类结构体，使用objc_msgSendSuper调用父类Set方法</span><br><span class="line">void setMethod2(id self, SEL _cmd, id newValue) &#123;</span><br><span class="line">    //获取get、set方法名</span><br><span class="line">    NSString *setNameStr = objc_getAssociatedObject(self, &quot;MKVO_Setter&quot;);</span><br><span class="line">    NSString *getNameStr = objc_getAssociatedObject(self, &quot;MKVO_Getter&quot;);</span><br><span class="line">    id observer = objc_getAssociatedObject(self, &quot;MKVO_Observer&quot;);</span><br><span class="line">    </span><br><span class="line">    struct objc_super superc = &#123;</span><br><span class="line">        self,</span><br><span class="line">        [self superclass]</span><br><span class="line">    &#125;;</span><br><span class="line">    //调用原类get方法，获取oldValue</span><br><span class="line">    id oldValue = objc_msgSendSuper(&amp;superc, NSSelectorFromString(getNameStr));</span><br><span class="line">    objc_msgSendSuper(&amp;superc, NSSelectorFromString(setNameStr), newValue);</span><br><span class="line">    </span><br><span class="line">    // 这里就全部返回了，也可以根据 options来定，需要返回新值，还是旧值</span><br><span class="line">    NSMutableDictionary *change = @&#123;&#125;.mutableCopy;</span><br><span class="line">    if (newValue) &#123;</span><br><span class="line">        change[NSKeyValueChangeNewKey] = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">    if (oldValue) &#123;</span><br><span class="line">        change[NSKeyValueChangeOldKey] = oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    objc_msgSend(observer, @selector(observeValueForKeyPath: ofObject: change: context:), getNameStr, self, change, nil);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)m_addObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath options:(NSKeyValueObservingOptions)options context:(void *)context</span><br><span class="line">&#123;</span><br><span class="line">    if(!keyPath.length || !observer) return;</span><br><span class="line">    // 类A的类名</span><br><span class="line">    NSString *clazz = NSStringFromClass(self.class);</span><br><span class="line">    NSString *subClazz = [@&quot;MKVO_&quot; stringByAppendingString:clazz];</span><br><span class="line">    </span><br><span class="line">    // 第一步 生成一个子类 - 判断之前有木有生成过该名字的子类</span><br><span class="line">    Class class = objc_getClass(subClazz.UTF8String);</span><br><span class="line">    if (!class) &#123;</span><br><span class="line">        class = objc_allocateClassPair(self.class, subClazz.UTF8String, 0);</span><br><span class="line">        // 把生成的子类注册，让系统知道</span><br><span class="line">        objc_registerClassPair(class);</span><br><span class="line">    &#125;</span><br><span class="line">    // 第二步 添加setter方法，用来覆盖父类（现有类）的setter方法</span><br><span class="line">    NSString *setterStr = [NSString stringWithFormat:@&quot;set%@:&quot;, [keyPath capitalizedString]];</span><br><span class="line">    SEL setsel = NSSelectorFromString(setterStr);</span><br><span class="line">    Method getMethod = class_getInstanceMethod([self class], @selector(keyPath));</span><br><span class="line">    const char *type = method_getTypeEncoding(getMethod);</span><br><span class="line">    class_addMethod(class, setsel, (IMP)setMethod2, type);</span><br><span class="line">    </span><br><span class="line">    //第三步 改变生成的子类的isa指针，指向父类（现有类A）</span><br><span class="line">    object_setClass(self, class);</span><br><span class="line">    </span><br><span class="line">    //保存observer</span><br><span class="line">    objc_setAssociatedObject(self, &quot;MKVO_Observer&quot;, observer, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">    objc_setAssociatedObject(self, &quot;MKVO_Setter&quot;, setterStr, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">    objc_setAssociatedObject(self, &quot;MKVO_Getter&quot;, keyPath, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>遇到的问题：</strong></p>
<ul>
<li><ol>
<li>报错  <strong>Too many arguments to function call, expected 0, have 6</strong><br>在<em>Build settings</em>找到选择 “<em>Enable Strict Checking of objc_msgSend</em>”, 设置成YES</li>
</ol>
</li>
<li><ol start="2">
<li>报错 <strong>Implicitly declaring library function ‘objc_msgSend’ with type ‘i</strong><br>导入头文件 “<em>#import &lt;objc/message.h&gt;</em>”</li>
</ol>
</li>
<li><ol start="3">
<li>在执行<code>objc_msgSend(self, setter, newValue);</code> 报错<em>Thread 1: EXC_BAD_ACCESS (code=1, address=0x14e746590)</em><br>在模拟器上没有出现此问题，运行正常。但是真机调试时，会产生程序中断了<br>解决：<br>把 <code>objc_msgSend</code>强制转换一下。代码如下：</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((void (*)(id self, SEL _cmd, id obj))objc_msgSend)(self, setter, newValue);</span><br></pre></td></tr></table></figure>





      </div>
      
        <br>
        


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2019-11-25T19:16:55+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>updated at Nov 25, 2019</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/KVO/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>KVO</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/2018/01/25/2018-01-25-kvo-customized/&title=KVO原理 & 自定义KVO | Philip的个人博客&summary=Apple文档对 KVO 实现的描述：

Automatic key-value observing is implemented using a technique called isa-swizzling.
The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.
When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.
You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.

KVO（key-value observe） 是在KVC的基础上实现的一种用于监听属性变化的设计模式； 如果对某个类的某个属性设置了KVO，那么当这个属性发生变化时，就会触发监听方法，从而知道属性变化了。如果本类一个属性的改变会影响到其他多个属性的变化，我们也会经常自己重写这个属性的set方法，用来监听他的变化，但是如果不是本类的属性，我们就没办法重写其set方法了，这个时候KVO就可以上场了，其实KVO本质上也是重写set方法，而整个过程依赖于runtime才能实现。 那么对于Apple文档所说到的“intermediate class”，是如何实现的呢？"
          
          >
          
            <img src="http://loupman.com/images/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://yoursite.com/2018/01/25/2018-01-25-kvo-customized/&title=KVO原理 & 自定义KVO | Philip的个人博客&summary=Apple文档对 KVO 实现的描述：

Automatic key-value observing is implemented using a technique called isa-swizzling.
The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.
When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.
You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.

KVO（key-value observe） 是在KVC的基础上实现的一种用于监听属性变化的设计模式； 如果对某个类的某个属性设置了KVO，那么当这个属性发生变化时，就会触发监听方法，从而知道属性变化了。如果本类一个属性的改变会影响到其他多个属性的变化，我们也会经常自己重写这个属性的set方法，用来监听他的变化，但是如果不是本类的属性，我们就没办法重写其set方法了，这个时候KVO就可以上场了，其实KVO本质上也是重写set方法，而整个过程依赖于runtime才能实现。 那么对于Apple文档所说到的“intermediate class”，是如何实现的呢？"
          
          >
          
            <img src="http://loupman.com/images/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-wechat" title="微信" rel="external nofollow noopener noreferrer"
          
          >
          
            <img src="http://loupman.com/images/wechat.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=http://yoursite.com/2018/01/25/2018-01-25-kvo-customized/&title=KVO原理 & 自定义KVO | Philip的个人博客&summary=Apple文档对 KVO 实现的描述：

Automatic key-value observing is implemented using a technique called isa-swizzling.
The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.
When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.
You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.

KVO（key-value observe） 是在KVC的基础上实现的一种用于监听属性变化的设计模式； 如果对某个类的某个属性设置了KVO，那么当这个属性发生变化时，就会触发监听方法，从而知道属性变化了。如果本类一个属性的改变会影响到其他多个属性的变化，我们也会经常自己重写这个属性的set方法，用来监听他的变化，但是如果不是本类的属性，我们就没办法重写其set方法了，这个时候KVO就可以上场了，其实KVO本质上也是重写set方法，而整个过程依赖于runtime才能实现。 那么对于Apple文档所说到的“intermediate class”，是如何实现的呢？"
          
          >
          
            <img src="http://loupman.com/images/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


      
      
          <div class="prev-next">
              
                  <section class="prev">
                      <span class="art-item-left">
                          <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;Previous</h6>
                          <h4>
                              <a href="/2019/02/13/2019-02-13-performselector-with-base-datatype-in-selector/" rel="prev" title="自定义同步调用的多个参数的m_performSelector">
                                
                                    自定义同步调用的多个参数的m_performSelector
                                
                              </a>
                          </h4>
                          
                              
                              <h6 class="tags">
                                  <a class="tag" href="/tags/KVO/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> KVO</a>
                              </h6>
                          
                      </span>
                  </section>
              
              
                  <section class="next">
                      <span class="art-item-right" aria-hidden="true">
                          <h6>Next&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                          <h4>
                              <a href="/2017/08/17/2017-08-17-brief-for-ios-library/" rel="prev" title="静态库和动态库简析">
                                  
                                      静态库和动态库简析
                                  
                              </a>
                          </h4>
                          
                              
                              <h6 class="tags">
                                  <a class="tag" href="/tags/%E9%9D%99%E6%80%81%E5%BA%93/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> 静态库</a> <a class="tag" href="/tags/%E5%8A%A8%E6%80%81%E5%BA%93/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> 动态库</a> <a class="tag" href="/tags/framework/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> .framework</a> <a class="tag" href="/tags/a/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> .a</a>
                              </h6>
                          
                      </span>
                  </section>
              
          </div>
      
    </section>
  </article>



  <!-- 显示推荐文章和评论 -->



  






<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'KVO原理 & 自定义KVO',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
      
        
          
          
            
              <section class='widget author'>
  <div class='content pure'>
    
      <div class='avatar'>
        <img class='avatar' src='http://loupman.com/images/avatar.png'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="/mailto:me@xaoxuu.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/xaoxuu"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=63035382"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
            
              
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;TOC</div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer noopener" href="javascript:void(0)" target="_blank"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#首先看下是如何使用的"><span class="toc-text">首先看下是如何使用的</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实现原理"><span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实现代码如下"><span class="toc-text">实现代码如下</span></a></li></ol>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
            
              <section class='widget grid'>
  
<header class='pure'>
  <div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div>
  
</header>

  <div class='content pure'>
    <ul class="grid navgation">
      
        <li><a class="flat-box" title="/" href="/"
          
          
          id="home">
          
            <i class="fas fa-clock fa-fw" aria-hidden="true"></i>
          
          近期文章
        </a></li>
      
        <li><a class="flat-box" title="/blog/archives/" href="/blog/archives/"
          
            rel="nofollow"
          
          
          id="blogarchives">
          
            <i class="fas fa-archive fa-fw" aria-hidden="true"></i>
          
          文章归档
        </a></li>
      
        <li><a class="flat-box" title="/projects/" href="/projects/"
          
          
          id="projects">
          
            <i class="fas fa-code-branch fa-fw" aria-hidden="true"></i>
          
          开源项目
        </a></li>
      
        <li><a class="flat-box" title="/friends/" href="/friends/"
          
            rel="nofollow"
          
          
          id="friends">
          
            <i class="fas fa-link fa-fw" aria-hidden="true"></i>
          
          我的友链
        </a></li>
      
        <li><a class="flat-box" title="https://xaoxuu.com/wiki/material-x/" href="https://xaoxuu.com/wiki/material-x/"
          
            rel="nofollow"
          
          
          id="https:xaoxuu.comwikimaterial-x">
          
            <i class="fas fa-book fa-fw" aria-hidden="true"></i>
          
          主题文档
        </a></li>
      
        <li><a class="flat-box" title="/about/" href="/about/"
          
            rel="nofollow"
          
          
          id="about">
          
            <i class="fas fa-info-circle fa-fw" aria-hidden="true"></i>
          
          关于小站
        </a></li>
      
    </ul>
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget category'>
    
<header class='pure'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;Categories</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/categories/"
    title="blog/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/Python/" href="/categories/Python/"><div class='name'>Python</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Swift/" href="/categories/Swift/"><div class='name'>Swift</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/github-pages/" href="/categories/github-pages/"><div class='name'>github / pages</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/iOS/" href="/categories/iOS/"><div class='name'>iOS</div><div class='badge'>(10)</div></a></li>
        
      </ul>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget tagcloud'>
    
<header class='pure'>
  <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;Hot Tags</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/tags/"
    title="blog/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <a href="/tags/a/" style="font-size: 14px; color: #999">.a</a> <a href="/tags/framework/" style="font-size: 14px; color: #999">.framework</a> <a href="/tags/KVO/" style="font-size: 24px; color: #555">KVO</a> <a href="/tags/Python/" style="font-size: 24px; color: #555">Python</a> <a href="/tags/Python2-7/" style="font-size: 24px; color: #555">Python2.7</a> <a href="/tags/Python%E5%87%BD%E6%95%B0/" style="font-size: 14px; color: #999">Python函数</a> <a href="/tags/Python%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size: 14px; color: #999">Python基本数据类型</a> <a href="/tags/Python%E6%A8%A1%E5%9D%97/" style="font-size: 14px; color: #999">Python模块</a> <a href="/tags/QQ%E5%85%AC%E4%BC%97%E5%8F%B7%E8%81%8A%E5%A4%A9/" style="font-size: 14px; color: #999">QQ公众号聊天</a> <a href="/tags/Realm/" style="font-size: 14px; color: #999">Realm</a> <a href="/tags/Swift/" style="font-size: 24px; color: #555">Swift</a> <a href="/tags/UITableViewCell/" style="font-size: 14px; color: #999">UITableViewCell</a> <a href="/tags/deviceId/" style="font-size: 14px; color: #999">deviceId</a> <a href="/tags/github/" style="font-size: 14px; color: #999">github</a> <a href="/tags/iOS/" style="font-size: 14px; color: #999">iOS</a> <a href="/tags/iOS-Crash/" style="font-size: 14px; color: #999">iOS Crash</a> <a href="/tags/iOS10-3/" style="font-size: 14px; color: #999">iOS10.3</a> <a href="/tags/iOS%E5%B4%A9%E6%BA%83/" style="font-size: 14px; color: #999">iOS崩溃</a> <a href="/tags/iOS%E9%97%AA%E9%80%80/" style="font-size: 14px; color: #999">iOS闪退</a> <a href="/tags/ipa%E7%A0%B8%E5%A3%B3/" style="font-size: 14px; color: #999">ipa砸壳</a> <a href="/tags/keychain/" style="font-size: 14px; color: #999">keychain</a> <a href="/tags/protobuf/" style="font-size: 14px; color: #999">protobuf</a> <a href="/tags/uuid/" style="font-size: 14px; color: #999">uuid</a> <a href="/tags/%E5%8A%A8%E6%80%81%E5%BA%93/" style="font-size: 14px; color: #999">动态库</a> <a href="/tags/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/" style="font-size: 14px; color: #999">域名解析</a> <a href="/tags/%E6%89%8B%E5%8A%A8%E7%AC%A6%E5%8F%B7%E5%8C%96/" style="font-size: 14px; color: #999">手动符号化</a> <a href="/tags/%E6%8B%86%E5%8C%85%E8%A7%A3%E5%8C%85/" style="font-size: 14px; color: #999">拆包解包</a> <a href="/tags/%E6%95%88%E6%9E%9C%E8%AE%BE%E7%BD%AE/" style="font-size: 14px; color: #999">效果设置</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/" style="font-size: 14px; color: #999">数据持久化</a> <a href="/tags/%E6%9E%9A%E4%B8%BE/" style="font-size: 14px; color: #999">枚举</a> <a href="/tags/%E7%B1%BB/" style="font-size: 14px; color: #999">类</a> <a href="/tags/%E7%BB%93%E6%9E%84%E4%BD%93/" style="font-size: 14px; color: #999">结构体</a> <a href="/tags/%E8%B0%83%E7%94%A8%E6%89%8B%E6%9C%BAQQ/" style="font-size: 14px; color: #999">调用手机QQ</a> <a href="/tags/%E8%B0%83%E8%AF%95%E5%BE%AE%E4%BF%A1/" style="font-size: 14px; color: #999">调试微信</a> <a href="/tags/%E9%9D%99%E6%80%81%E5%BA%93/" style="font-size: 14px; color: #999">静态库</a>
    </div>
  </section>


            
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="/mailto:me@xaoxuu.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/xaoxuu"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://music.163.com/#/user/home?id=63035382"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
  <div>
    Use
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    as theme
    
      , 
      total visits
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      times
    
    . 
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)' target="_blank" rel="noopener"></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://img.vim-cn.com/29/91197b04c13f512f734a76d4ac422d89dbe229.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://img.vim-cn.com/29/91197b04c13f512f734a76d4ac422d89dbe229.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  <script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.9/js/app.js"></script>


  <script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.9/js/search.js"></script>




<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "Copied";
  let COPY_FAILURE = "Copy failed";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>Copy</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
